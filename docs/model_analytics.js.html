<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>model/analytics.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h3>Namespaces</h3><ul><li><a href="Fn.html">Fn</a><ul class='methods'><li data-type='method'><a href="Fn.html#.all">all</a></li><li data-type='method'><a href="Fn.html#.init">init</a></li></ul></li></ul><h3>Tutorials</h3><ul><li><a href="tutorial-Analytics_.html">Analytics</a><ul class='methods'><li data-type='method'><a href="Analytics.html#get">get</a></li><li data-type='method'><a href="Analytics.html#getDependecyFetchResults">getDependecyFetchResults</a></li><li data-type='method'><a href="Analytics.html#getSanitizedAnalyticsMetadata">getSanitizedAnalyticsMetadata</a></li><li data-type='method'><a href="Analytics.html#setData">setData</a></li><li data-type='method'><a href="Analytics.html#setDimension">setDimension</a></li><li data-type='method'><a href="Analytics.html#setOrgUnit">setOrgUnit</a></li><li data-type='method'><a href="Analytics.html#setParameters">setParameters</a></li><li data-type='method'><a href="Analytics.html#setPeriod">setPeriod</a></li><li data-type='method'><a href="Analytics.html#setSelections">setSelections</a></li><li data-type='method'><a href="Analytics.html#standardizeAnalytics">standardizeAnalytics</a></li></ul></li><li><a href="tutorial-Generic-Functions.html">Generic-Functions</a></li></ul><h3>Classes</h3><ul><li><a href="Analytics.html">Analytics</a><ul class='methods'><li data-type='method'><a href="Analytics.html#get">get</a></li><li data-type='method'><a href="Analytics.html#getDependecyFetchResults">getDependecyFetchResults</a></li><li data-type='method'><a href="Analytics.html#getSanitizedAnalyticsMetadata">getSanitizedAnalyticsMetadata</a></li><li data-type='method'><a href="Analytics.html#setData">setData</a></li><li data-type='method'><a href="Analytics.html#setDimension">setDimension</a></li><li data-type='method'><a href="Analytics.html#setOrgUnit">setOrgUnit</a></li><li data-type='method'><a href="Analytics.html#setParameters">setParameters</a></li><li data-type='method'><a href="Analytics.html#setPeriod">setPeriod</a></li><li data-type='method'><a href="Analytics.html#setSelections">setSelections</a></li><li data-type='method'><a href="Analytics.html#standardizeAnalytics">standardizeAnalytics</a></li></ul></li><li><a href="AnalyticsHeader.html">AnalyticsHeader</a></li><li><a href="AnalyticsHeaders.html">AnalyticsHeaders</a><ul class='methods'><li data-type='method'><a href="AnalyticsHeaders.html#getHeader">getHeader</a></li></ul></li><li><a href="AnalyticsResult.html">AnalyticsResult</a><ul class='methods'><li data-type='method'><a href="AnalyticsResult.html#getDimensionDetails">getDimensionDetails</a></li><li data-type='method'><a href="AnalyticsResult.html#getDimensionDetailsByName">getDimensionDetailsByName</a></li></ul></li><li><a href="Dependency.html">Dependency</a></li><li><a href="EventAnalytics.html">EventAnalytics</a><ul class='methods'><li data-type='method'><a href="EventAnalytics.html#get">get</a></li><li data-type='method'><a href="EventAnalytics.html#getDependecyFetchResults">getDependecyFetchResults</a></li><li data-type='method'><a href="EventAnalytics.html#getSanitizedAnalyticsMetadata">getSanitizedAnalyticsMetadata</a></li><li data-type='method'><a href="EventAnalytics.html#setData">setData</a></li><li data-type='method'><a href="EventAnalytics.html#setDimension">setDimension</a></li><li data-type='method'><a href="EventAnalytics.html#setOrgUnit">setOrgUnit</a></li><li data-type='method'><a href="EventAnalytics.html#setParameters">setParameters</a></li><li data-type='method'><a href="EventAnalytics.html#setPeriod">setPeriod</a></li><li data-type='method'><a href="EventAnalytics.html#setProgram">setProgram</a></li><li data-type='method'><a href="EventAnalytics.html#setSelections">setSelections</a></li><li data-type='method'><a href="EventAnalytics.html#standardizeAnalytics">standardizeAnalytics</a></li></ul></li><li><a href="Fetcher.html">Fetcher</a><ul class='methods'><li data-type='method'><a href="Fetcher.html#addPostProcess">addPostProcess</a></li><li data-type='method'><a href="Fetcher.html#addPreProcess">addPreProcess</a></li><li data-type='method'><a href="Fetcher.html#get">get</a></li><li data-type='method'><a href="Fetcher.html#getDependecyFetchResults">getDependecyFetchResults</a></li><li data-type='method'><a href="Fetcher.html#hasDependencies">hasDependencies</a></li><li data-type='method'><a href="Fetcher.html#performPostProcess">performPostProcess</a></li><li data-type='method'><a href="Fetcher.html#performPreProcess">performPreProcess</a></li><li data-type='method'><a href="Fetcher.html#postProcess">postProcess</a></li><li data-type='method'><a href="Fetcher.html#preProcess">preProcess</a></li><li data-type='method'><a href="Fetcher.html#setParameters">setParameters</a></li></ul></li><li><a href="IdentifiableObject.html">IdentifiableObject</a><ul class='methods'><li data-type='method'><a href="IdentifiableObject.html#get">get</a></li><li data-type='method'><a href="IdentifiableObject.html#getDependecyFetchResults">getDependecyFetchResults</a></li><li data-type='method'><a href="IdentifiableObject.html#setParameters">setParameters</a></li><li data-type='method'><a href="IdentifiableObject.html#where">where</a></li></ul></li><li><a href="MultiFetcher.html">MultiFetcher</a><ul class='methods'><li data-type='method'><a href="MultiFetcher.html#addPostProcess">addPostProcess</a></li><li data-type='method'><a href="MultiFetcher.html#addPreProcess">addPreProcess</a></li><li data-type='method'><a href="MultiFetcher.html#get">get</a></li><li data-type='method'><a href="MultiFetcher.html#getDependecyFetchResults">getDependecyFetchResults</a></li><li data-type='method'><a href="MultiFetcher.html#hasDependencies">hasDependencies</a></li><li data-type='method'><a href="MultiFetcher.html#performPostProcess">performPostProcess</a></li><li data-type='method'><a href="MultiFetcher.html#performPreProcess">performPreProcess</a></li><li data-type='method'><a href="MultiFetcher.html#postProcess">postProcess</a></li><li data-type='method'><a href="MultiFetcher.html#preProcess">preProcess</a></li><li data-type='method'><a href="MultiFetcher.html#setParameters">setParameters</a></li></ul></li><li><a href="Period.html">Period</a><ul class='methods'><li data-type='method'><a href="Period.html#setType">setType</a></li></ul></li><li><a href="Process.html">Process</a><ul class='methods'><li data-type='method'><a href="Process.html#addPostProcess">addPostProcess</a></li><li data-type='method'><a href="Process.html#addPreProcess">addPreProcess</a></li><li data-type='method'><a href="Process.html#hasDependencies">hasDependencies</a></li><li data-type='method'><a href="Process.html#performPostProcess">performPostProcess</a></li><li data-type='method'><a href="Process.html#performPreProcess">performPreProcess</a></li><li data-type='method'><a href="Process.html#postProcess">postProcess</a></li><li data-type='method'><a href="Process.html#preProcess">preProcess</a></li></ul></li><li><a href="ProgressPromise.html">ProgressPromise</a><ul class='methods'><li data-type='method'><a href="ProgressPromise.html#.all">all</a></li><li data-type='method'><a href="ProgressPromise.html#.sequence">sequence</a></li><li data-type='method'><a href="ProgressPromise.html#progress">progress</a></li></ul></li><li><a href="Row.html">Row</a><ul class='methods'><li data-type='method'><a href="Row.html#dimension">dimension</a></li></ul></li><li><a href="Runner.html">Runner</a><ul class='methods'><li data-type='method'><a href="Runner.html#.initiateRunner">initiateRunner</a></li><li data-type='method'><a href="Runner.html#getAllResults">getAllResults</a></li><li data-type='method'><a href="Runner.html#getResults">getResults</a></li></ul></li><li><a href="SQLViewData.html">SQLViewData</a><ul class='methods'><li data-type='method'><a href="SQLViewData.html#get">get</a></li><li data-type='method'><a href="SQLViewData.html#getDependecyFetchResults">getDependecyFetchResults</a></li><li data-type='method'><a href="SQLViewData.html#setParameters">setParameters</a></li><li data-type='method'><a href="SQLViewData.html#setVariable">setVariable</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#processCallback">processCallback</a></li><li><a href="global.html#rejectCallback">rejectCallback</a></li><li><a href="global.html#resolveCallback">resolveCallback</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">model/analytics.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { Fetcher } from '../utilities/fetcher';
import { AnalyticsResult } from '../result/analytics-result';
/**
 * @description
 * This represents the Analytics Fetcher for processing for making Web API calls
 * @example
 * const analytics = Fn.Analytics();
 * @extends Fetcher
 */
export class Analytics extends Fetcher {
  /**
   * @description
   * Creates an analytics fethcer
   *
   * @param {Number} version - The version of dhis analytics structure to use
   */
  constructor(version = 25) {
    super();
    if (typeof version === 'boolean') {
      if (version) {
        version = 25;
      } else {
        version = 26;
      }
    }
    this.parameters['dimension'] = {};
    this.postProcess(data => {
      return this.standardizeAnalytics(data, version);
    });
  }

  /**
   * Sets the data for the fetch
   * @param {string} dx The id of the data to get
   * @returns {Analytics} - Object with the analytics interaction properties
   */
  setData(dx) {
    this.setDimension('dx', dx);
    return this;
  }

  /**
   * Sets the period for the fetch
   * @param {string} pe The id of the period to get data from
   * @returns {Analytics} Object with the analytics interaction properties
   */
  setPeriod(pe) {
    this.setDimension('pe', pe);
    return this;
  }

  /**
   * Sets the organisation unit for the fetching of the analytics
   * @param {string} ou - Organisation unit
   * @returns {Analytics} Object with the analytics interaction properties
   */
  setOrgUnit(ou) {
    this.setDimension('ou', ou);
    return this;
  }

  /**
   * Sets the data,period and organisation unit from function input parameters object for the fetching of the analytics
   * @param {string} parameters - Rule parameters
   * @returns {Analytics} Object with the analytics interaction properties
   */
  setSelections(parameters) {
    this.setPeriod(parameters.pe);
    this.setOrgUnit(parameters.ou);
    // Set data Selection
    if (parameters.rule.json.data !== undefined) {
      // @TODO add support for only fetching 11char long uids, and joining them
      // into a comma separated string, so in future, parameters.rule.json.data
      // could simply be an indicator expresssion with unary operators and javascript
      // functions inside to be executed the express parameters.rule.json.data
      this.setData(parameters.rule.json.data);
    }
    // Set dynamic dimension
    if (parameters.dimensions !== undefined &amp;&amp; Array.isArray(parameters.dimensions)) {
      parameters.dimensions.forEach(function (dimension) {
        if (Array.isArray(dimension.items)) {
          let dimensionItems = '';

          dimension.items.forEach(function (item) {
            dimensionItems.length > 0 ? dimensionItems += ';' + item : dimensionItems += item;
          });
          this.setDimension(dimension.id, dimensionItems);
        }
      });
    }
    return this;
  }

  /**
   * Sets the dimension for the fetching of the analytics
   * @param {string} dim - Dynamic Dimension identifier
   * @param {string} value - Dynamic dimension options identifiers
   * @returns {Analytics} Object with the analytics interaction properties
   */
  setDimension(dim, value) {
    this.parameters['dimension'][dim] = value ? value : '';
    return this;
  }

  /**
   * Standardizes the analytics object
   *
   * @param {Object} analyticsObject - The analytics object
   * @param {Number} version - The version of dhis analytics structure to use
   * @returns {AnalyticsResult} - Object with the analytics results
   */
  standardizeAnalytics(analyticsObject, version = 25) {
    if (typeof version === 'boolean') {
      if (version) {
        version = 25;
      } else {
        version = 26;
      }
    }
    // if Serverside Event clustering do nothing
    if (analyticsObject.count) {
      return analyticsObject;
    }
    let sanitizedAnalyticsObject = {
      headers: [],
      metaData: {
        dimensions: {},
        names: {},
        dx: [],
        pe: [],
        ou: [],
        co: []
      },
      rows: []
    };

    if (analyticsObject) {
      /**
       * Check headers
       */
      if (analyticsObject.headers) {
        analyticsObject.headers.forEach(header => {
          try {
            let newHeader = header;

            sanitizedAnalyticsObject.headers.push(newHeader);
          } catch (e) {
            console.warn('Invalid header object');
          }
        });
      }

      /**
       * Check metaData
       */
      if (analyticsObject.metaData) {
        try {
          let sanitizedMetadata = this.getSanitizedAnalyticsMetadata(
            analyticsObject.metaData,
            version
          );

          sanitizedAnalyticsObject.metaData = sanitizedMetadata;
        } catch (e) {
          console.warn('Invalid metadata object');
        }
      }

      /**
       * Check rows
       */
      if (analyticsObject.rows) {
        sanitizedAnalyticsObject.rows = analyticsObject.rows;
      }
    }
    sanitizedAnalyticsObject.height = analyticsObject.height;
    sanitizedAnalyticsObject.width = analyticsObject.width;
    return new AnalyticsResult(sanitizedAnalyticsObject);
  }

  /**
   * Standardizes the analytics metadata object
   *
   * @param {Object} analyticMetadata - The analytics metadata object
   * @param {Number} version - The version of dhis analytics structure to use
   * @returns {Object} - Object with the analytics metadata
   */
  getSanitizedAnalyticsMetadata(analyticMetadata, version) {
    let sanitizedMetadata = {};

    if (analyticMetadata) {
      if (analyticMetadata.ouHierarchy) {
        sanitizedMetadata.ouHierarchy = analyticMetadata.ouHierarchy;
      }
      if (version &lt; 26) {
        // Get old structure
        sanitizedMetadata.names = {};
        if (analyticMetadata.names) {
          sanitizedMetadata.names = analyticMetadata.names;
        } else if (analyticMetadata.items) {
          Object.keys(analyticMetadata.items).forEach(nameKey => {
            sanitizedMetadata.names[nameKey] =
              analyticMetadata.items[nameKey].name;
          });
        }

        if (analyticMetadata.dimensions) {
          Object.keys(analyticMetadata.dimensions).forEach(nameKey => {
            sanitizedMetadata[nameKey] = analyticMetadata.dimensions[nameKey];
          });
        }
      } else {
        // Get new structure
        sanitizedMetadata.items = {};
        if (analyticMetadata.items) {
          sanitizedMetadata.items = analyticMetadata.items;
        } else if (analyticMetadata.names) {
          Object.keys(analyticMetadata.items).forEach(nameKey => {
            analyticMetadata.items[nameKey] = {
              name: analyticMetadata.names[nameKey]
            };
          });
        }

        if (!analyticMetadata.dimensions) {
          sanitizedMetadata.dimensions = {};
          Object.keys(analyticMetadata).forEach(nameKey => {
            if (['names', 'items', 'dimensions'].indexOf(nameKey) === -1) {
              sanitizedMetadata.dimensions[nameKey] = analyticMetadata[nameKey];
            }
          });
        } else {
          sanitizedMetadata.dimensions = analyticMetadata.dimensions;
        }
      }
    }
    return sanitizedMetadata;
  }

  /**
   * Gets the url for fetching
   * @returns {string}
   */
  get url() {
    return 'analytics?' + this._urlParameters;
  }
}
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Fri Sep 13 2019 15:18:59 GMT+0300 (East Africa Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>



</body>
</html>
